<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PinGlass - Документация</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --pink-500: #ec4899;
            --pink-600: #db2777;
            --pink-100: #fce7f3;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--gray-50);
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: white;
            border-right: 1px solid var(--gray-200);
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
        }

        nav h1 {
            color: var(--pink-600);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        nav p {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 20px;
        }

        nav ul {
            list-style: none;
        }

        nav ul li {
            margin-bottom: 5px;
        }

        nav ul li a {
            display: block;
            padding: 8px 12px;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        nav ul li a:hover {
            background: var(--pink-100);
            color: var(--pink-600);
        }

        nav ul li a.active {
            background: var(--pink-500);
            color: white;
        }

        nav .section-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Main Content */
        main {
            margin-left: 280px;
            padding: 40px;
            max-width: 1200px;
        }

        section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h2 {
            color: var(--gray-900);
            font-size: 1.75rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--pink-500);
        }

        h3 {
            color: var(--gray-800);
            font-size: 1.25rem;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        h4 {
            color: var(--gray-700);
            font-size: 1rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            color: var(--gray-600);
        }

        ul, ol {
            margin-bottom: 15px;
            padding-left: 25px;
        }

        li {
            margin-bottom: 8px;
            color: var(--gray-600);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-800);
        }

        tr:hover {
            background: var(--gray-50);
        }

        /* Code */
        code {
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
            color: var(--pink-600);
        }

        pre {
            background: var(--gray-900);
            color: #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--gray-200);
        }

        .card h4 {
            margin-top: 0;
            color: var(--pink-600);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--pink-500), var(--pink-600));
            border-radius: 10px;
            color: white;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-pink { background: var(--pink-100); color: var(--pink-600); }
        .badge-green { background: #d1fae5; color: #059669; }
        .badge-blue { background: #dbeafe; color: #2563eb; }
        .badge-yellow { background: #fef3c7; color: #d97706; }
        .badge-red { background: #fee2e2; color: #dc2626; }
        .badge-purple { background: #f3e8ff; color: #9333ea; }

        /* Screenshots */
        .screenshot {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .screenshot img {
            width: 100%;
            display: block;
        }

        .screenshot-caption {
            padding: 12px 15px;
            background: var(--gray-100);
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        /* Mermaid diagrams */
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Flow diagram container */
        .flow-container {
            background: var(--gray-100);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }

        /* Admin feature box */
        .admin-feature {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin: 15px 0;
        }

        .admin-feature h4 {
            color: var(--gray-900);
            margin-top: 0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .admin-feature .kpi-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-feature .kpi-item {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid var(--gray-200);
        }

        .admin-feature .features-list {
            padding-left: 20px;
        }

        .admin-feature .features-list li {
            margin-bottom: 6px;
        }

        /* Tab indicator */
        .tabs-indicator {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        .tab-badge {
            background: var(--pink-100);
            color: var(--pink-600);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            nav {
                width: 100%;
                height: auto;
                position: relative;
            }
            main {
                margin-left: 0;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Print styles */
        @media print {
            nav { display: none; }
            main { margin-left: 0; }
            section { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <nav>
        <h1>PinGlass</h1>
        <p>Документация проекта v3.0</p>

        <div class="section-title">Обзор</div>
        <ul>
            <li><a href="#overview">О проекте</a></li>
            <li><a href="#features">Функционал</a></li>
            <li><a href="#tech-stack">Технологии</a></li>
        </ul>

        <div class="section-title">Архитектура</div>
        <ul>
            <li><a href="#architecture">Общая архитектура</a></li>
            <li><a href="#database">База данных</a></li>
            <li><a href="#api">API Endpoints</a></li>
            <li><a href="#payments">Платежи</a></li>
            <li><a href="#generation">AI Генерация</a></li>
        </ul>

        <div class="section-title">Интерфейс</div>
        <ul>
            <li><a href="#ui-user">Пользовательский UI</a></li>
            <li><a href="#ui-admin">Админ панель</a></li>
            <li><a href="#admin-sections">11 секций админки</a></li>
            <li><a href="#telegram-mini-app">Telegram Mini App</a></li>
            <li><a href="#user-flow">User Flow</a></li>
        </ul>

        <div class="section-title">Разработка</div>
        <ul>
            <li><a href="#deployment">Деплой</a></li>
            <li><a href="#env-vars">Переменные</a></li>
        </ul>
    </nav>

    <main>
        <!-- OVERVIEW -->
        <section id="overview">
            <h2>О проекте PinGlass</h2>

            <p><strong>PinGlass</strong> (розовые очки) — веб-приложение для генерации AI-фотопортретов. Пользователи загружают свои фотографии и получают профессиональные AI-сгенерированные портреты в различных стилях.</p>

            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-value">23</div>
                    <div class="stat-label">фото за генерацию</div>
                </div>
                <div class="stat">
                    <div class="stat-value">3</div>
                    <div class="stat-label">способа оплаты</div>
                </div>
                <div class="stat">
                    <div class="stat-value">11</div>
                    <div class="stat-label">секций админ панели</div>
                </div>
                <div class="stat">
                    <div class="stat-value">50%</div>
                    <div class="stat-label">партнёрская комиссия</div>
                </div>
            </div>

            <h3>Ключевые возможности</h3>
            <ul>
                <li><strong>AI-генерация портретов</strong> — до 23 уникальных фото на основе загруженных референсов</li>
                <li><strong>Telegram Mini App</strong> — полная интеграция с Telegram (авторизация, Stars, уведомления)</li>
                <li><strong>Мультиплатёжность</strong> — T-Bank (карты), Telegram Stars, TON (криптовалюта)</li>
                <li><strong>Реферальная система</strong> — партнёрская программа с 10%/50% комиссией</li>
                <li><strong>Админ панель</strong> — 11 секций полного управления платформой</li>
                <li><strong>Фотопаки</strong> — готовые наборы промптов (PinGlass Premium, DREAM PACK)</li>
            </ul>
        </section>

        <!-- FEATURES -->
        <section id="features">
            <h2>Функционал</h2>

            <h3>Для пользователей</h3>
            <div class="card-grid">
                <div class="card">
                    <h4>Загрузка фото</h4>
                    <p>Drag-n-drop загрузка 5-20 референсных фотографий с превью, удалением и советами по качеству.</p>
                </div>
                <div class="card">
                    <h4>Выбор тарифа</h4>
                    <p>3 тарифа: Starter (7 фото / 499р), Standard (15 фото / 999р), Premium (23 фото / 1499р).</p>
                </div>
                <div class="card">
                    <h4>Оплата</h4>
                    <p>T-Bank (банковские карты), Telegram Stars (внутри TG), TON (криптовалюта через Tonkeeper).</p>
                </div>
                <div class="card">
                    <h4>Галерея результатов</h4>
                    <p>Просмотр и скачивание готовых AI-фотографий. Генерация в фоне с уведомлением по готовности.</p>
                </div>
                <div class="card">
                    <h4>Множество аватаров</h4>
                    <p>Создание нескольких "персон" — разных наборов референсных фото для разных стилей.</p>
                </div>
                <div class="card">
                    <h4>Реферальная программа</h4>
                    <p>Персональный реферальный код, 10% комиссия (50% для партнёров), история начислений, вывод средств.</p>
                </div>
            </div>

            <h3>Для администраторов</h3>
            <div class="card-grid">
                <div class="card">
                    <h4>Dashboard</h4>
                    <p>KPI карточки, графики выручки за 30 дней, распределение по тарифам, статистика провайдеров.</p>
                </div>
                <div class="card">
                    <h4>Управление платежами</h4>
                    <p>Фильтрация по провайдеру/статусу/тарифу, возвраты одним кликом, экспорт данных.</p>
                </div>
                <div class="card">
                    <h4>Редактор промптов</h4>
                    <p>Тестер с референсами, 40+ сохранённых промптов, фотопаки, массовая генерация.</p>
                </div>
                <div class="card">
                    <h4>Партнёрская система</h4>
                    <p>Заявки на партнёрство, 50% комиссия партнёрам, статистика рефералов, выплаты.</p>
                </div>
                <div class="card">
                    <h4>Telegram рассылки</h4>
                    <p>Сегментация аудитории, HTML форматирование, прикрепление фото, история рассылок.</p>
                </div>
                <div class="card">
                    <h4>Логи и мониторинг</h4>
                    <p>Интеграция с Sentry, фильтрация по уровню (error/warn/info), Live режим.</p>
                </div>
            </div>
        </section>

        <!-- TECH STACK -->
        <section id="tech-stack">
            <h2>Технологический стек</h2>

            <table>
                <tr>
                    <th>Категория</th>
                    <th>Технология</th>
                    <th>Описание</th>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Frontend</span></td>
                    <td>Next.js 16, React 19</td>
                    <td>App Router, Server Components, Turbopack</td>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Frontend</span></td>
                    <td>TypeScript</td>
                    <td>Строгая типизация всего кода</td>
                </tr>
                <tr>
                    <td><span class="badge badge-blue">Frontend</span></td>
                    <td>Tailwind CSS 4</td>
                    <td>OKLCH цветовое пространство, CSS переменные</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Backend</span></td>
                    <td>Neon PostgreSQL</td>
                    <td>Serverless база данных с branching</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Backend</span></td>
                    <td>Vercel Edge Functions</td>
                    <td>Serverless API с maxDuration до 300s</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Backend</span></td>
                    <td>QStash</td>
                    <td>Background jobs, очереди задач</td>
                </tr>
                <tr>
                    <td><span class="badge badge-pink">AI</span></td>
                    <td>Kie.ai</td>
                    <td>Основной провайдер AI-генерации (async)</td>
                </tr>
                <tr>
                    <td><span class="badge badge-pink">AI</span></td>
                    <td>Replicate</td>
                    <td>Fallback провайдер</td>
                </tr>
                <tr>
                    <td><span class="badge badge-yellow">Storage</span></td>
                    <td>Cloudflare R2</td>
                    <td>S3-совместимое хранилище изображений</td>
                </tr>
                <tr>
                    <td><span class="badge badge-purple">Payments</span></td>
                    <td>T-Bank, Stars, TON</td>
                    <td>Мульти-провайдерная система платежей</td>
                </tr>
            </table>
        </section>

        <!-- ARCHITECTURE -->
        <section id="architecture">
            <h2>Архитектура системы</h2>

            <h3>Общая схема</h3>
            <div class="mermaid">
graph TB
    subgraph "Client"
        TG[Telegram Mini App]
        WEB[Web Browser]
    end

    subgraph "Vercel Edge"
        API[Next.js API Routes]
        SSR[Server Components]
    end

    subgraph "Background Jobs"
        QSTASH[QStash Queue]
        CRON[Vercel Cron]
    end

    subgraph "AI Generation"
        KIE[Kie.ai API]
        REP[Replicate Fallback]
    end

    subgraph "Storage"
        NEON[(Neon PostgreSQL)]
        R2[Cloudflare R2]
    end

    subgraph "Payments"
        TBANK[T-Bank]
        STARS[Telegram Stars]
        TON[TON Blockchain]
    end

    TG --> API
    WEB --> API
    API --> NEON
    API --> QSTASH
    QSTASH --> KIE
    KIE --> R2
    CRON --> API
    API --> TBANK
    API --> STARS
    API --> TON
            </div>

            <h3>Структура проекта</h3>
            <pre><code>PinGlass/
├── app/                      # Next.js App Router
│   ├── api/                  # API endpoints
│   │   ├── admin/            # Админ API (30+ endpoints)
│   │   ├── generate/         # AI генерация
│   │   ├── payment/          # Платежи (T-Bank, Stars, TON)
│   │   ├── user/             # Пользователи
│   │   ├── referral/         # Реферальная система
│   │   └── cron/             # Cron jobs
│   ├── admin/                # Админ панель (11 страниц)
│   │   ├── dashboard/        # KPI и графики
│   │   ├── users/            # Управление пользователями
│   │   ├── payments/         # Управление платежами
│   │   ├── generations/      # Мониторинг генераций
│   │   ├── prompts/          # Редактор промптов
│   │   ├── referrals/        # Реферальная статистика
│   │   ├── partners/         # Партнёрская программа
│   │   ├── telegram/         # Telegram рассылки
│   │   ├── tickets/          # Support тикеты
│   │   ├── logs/             # Логи и мониторинг
│   │   └── settings/         # Настройки системы
│   └── page.tsx              # Главная страница
├── components/
│   ├── views/                # View компоненты
│   ├── payment-modal.tsx     # Модал оплаты
│   └── persona-app.tsx       # Главный компонент
├── lib/
│   ├── payments/             # Платёжная система
│   │   ├── providers/        # T-Bank, Stars, TON
│   │   └── factory.ts        # Provider factory
│   ├── kie.ts                # Kie.ai интеграция
│   ├── db.ts                 # Database client
│   └── tonconnect/           # TON Connect 2.0
└── styles/globals.css        # Глобальные стили</code></pre>
        </section>

        <!-- DATABASE -->
        <section id="database">
            <h2>База данных</h2>

            <h3>Ключевые таблицы</h3>

            <div class="mermaid">
erDiagram
    users ||--o{ avatars : has
    users ||--o{ payments : makes
    users ||--o| referral_balances : has
    avatars ||--o{ generation_jobs : has
    generation_jobs ||--o{ kie_tasks : contains
    generation_jobs ||--o{ generated_photos : produces

    users {
        int id PK
        bigint telegram_user_id UK
        string telegram_username
        string neon_auth_id UK
        string email
        boolean is_banned
    }

    payments {
        int id PK
        int user_id FK
        string payment_id
        string provider
        decimal amount
        string status
        string telegram_charge_id UK
        string ton_tx_hash UK
    }

    avatars {
        int id PK
        int user_id FK
        string name
        string status
        string thumbnail_url
    }

    kie_tasks {
        int id PK
        int job_id FK
        string kie_task_id
        int prompt_index
        string status
        string result_url
    }
            </div>

            <h3>Важные особенности</h3>
            <ul>
                <li><strong>Нет статусов Free/Pro</strong> — доступ определяется наличием успешного платежа</li>
                <li><strong>UNIQUE индексы</strong> на telegram_charge_id и ton_tx_hash для защиты от double-spending</li>
                <li><strong>Soft delete</strong> для критичных данных через is_deleted флаги</li>
                <li><strong>29 миграций</strong> — полная история изменений схемы</li>
            </ul>
        </section>

        <!-- API -->
        <section id="api">
            <h2>API Endpoints</h2>

            <h3>Пользовательские API</h3>
            <table>
                <tr><th>Endpoint</th><th>Метод</th><th>Описание</th></tr>
                <tr><td><code>/api/user</code></td><td>POST</td><td>Создание/получение пользователя</td></tr>
                <tr><td><code>/api/avatars</code></td><td>GET/POST</td><td>Список/создание аватаров</td></tr>
                <tr><td><code>/api/generate</code></td><td>POST</td><td>Запуск AI генерации</td></tr>
                <tr><td><code>/api/pricing</code></td><td>GET</td><td>Получение тарифов</td></tr>
                <tr><td><code>/api/referral/info</code></td><td>GET</td><td>Реферальная информация</td></tr>
            </table>

            <h3>Платёжные API</h3>
            <table>
                <tr><th>Endpoint</th><th>Метод</th><th>Описание</th></tr>
                <tr><td><code>/api/payment/create</code></td><td>POST</td><td>Создание платежа T-Bank</td></tr>
                <tr><td><code>/api/payment/stars/create</code></td><td>POST</td><td>Создание Stars invoice</td></tr>
                <tr><td><code>/api/payment/ton/create</code></td><td>POST</td><td>Создание TON платежа</td></tr>
                <tr><td><code>/api/payment/status</code></td><td>GET</td><td>Проверка статуса</td></tr>
                <tr><td><code>/api/payment/webhook/*</code></td><td>POST</td><td>Webhook обработчики</td></tr>
            </table>

            <h3>Админ API</h3>
            <table>
                <tr><th>Endpoint</th><th>Метод</th><th>Описание</th></tr>
                <tr><td><code>/api/admin/auth/*</code></td><td>*</td><td>Аутентификация админа</td></tr>
                <tr><td><code>/api/admin/stats</code></td><td>GET</td><td>Dashboard статистика</td></tr>
                <tr><td><code>/api/admin/payments</code></td><td>GET</td><td>Список платежей</td></tr>
                <tr><td><code>/api/admin/generations</code></td><td>GET</td><td>Список генераций</td></tr>
                <tr><td><code>/api/admin/prompts</code></td><td>CRUD</td><td>Управление промптами</td></tr>
                <tr><td><code>/api/admin/partners</code></td><td>CRUD</td><td>Управление партнёрами</td></tr>
                <tr><td><code>/api/admin/telegram/broadcast</code></td><td>POST</td><td>Telegram рассылка</td></tr>
            </table>
        </section>

        <!-- PAYMENTS -->
        <section id="payments">
            <h2>Платёжная система</h2>

            <h3>Провайдеры</h3>
            <div class="card-grid">
                <div class="card">
                    <h4>T-Bank (Тинькофф)</h4>
                    <p><strong>Основной провайдер</strong></p>
                    <ul>
                        <li>Банковские карты РФ</li>
                        <li>54-ФЗ онлайн-чеки</li>
                        <li>Возвраты через API</li>
                        <li>Test / Production режимы</li>
                    </ul>
                    <span class="badge badge-green">Production Ready</span>
                </div>
                <div class="card">
                    <h4>Telegram Stars</h4>
                    <p><strong>Внутри Telegram</strong></p>
                    <ul>
                        <li>Оплата Stars (XTR)</li>
                        <li>Bot API интеграция</li>
                        <li>Мгновенное подтверждение</li>
                        <li>Курс: 1 Star = ~1.8 RUB</li>
                    </ul>
                    <span class="badge badge-blue">Telegram Only</span>
                </div>
                <div class="card">
                    <h4>TON Blockchain</h4>
                    <p><strong>Криптовалюта</strong></p>
                    <ul>
                        <li>TON Connect 2.0</li>
                        <li>Tonkeeper интеграция</li>
                        <li>Автоматический курс (обновление каждые 5 мин)</li>
                        <li>Цены: 1.5 / 3 / 4.5 TON</li>
                    </ul>
                    <span class="badge badge-yellow">Crypto</span>
                </div>
            </div>

            <h3>Flow оплаты</h3>
            <div class="mermaid">
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as API
    participant P as Payment Provider
    participant DB as Database

    U->>F: Выбор тарифа
    F->>A: POST /api/payment/create
    A->>DB: Создать pending payment
    A->>P: Создать заказ
    P-->>A: Payment URL
    A-->>F: Redirect URL
    F->>P: Редирект на оплату
    U->>P: Оплата
    P->>A: Webhook (success)
    A->>DB: Update status = succeeded
    A-->>F: Payment confirmed
    F->>U: Показать генерацию
            </div>
        </section>

        <!-- GENERATION -->
        <section id="generation">
            <h2>AI Генерация</h2>

            <h3>Асинхронная архитектура</h3>
            <p>Из-за лимита Cloudflare в 100 секунд используется fire-and-forget паттерн с cron polling:</p>

            <div class="mermaid">
sequenceDiagram
    participant U as User
    participant A as API
    participant Q as QStash
    participant K as Kie.ai
    participant C as Cron
    participant DB as Database

    U->>A: POST /api/generate
    A->>DB: Create generation_job
    A->>Q: Queue task
    A-->>U: Job ID (0.5s)

    Q->>A: /api/jobs/process
    A->>K: Create Kie task
    A->>DB: Save kie_task_id

    loop Every minute
        C->>A: /api/cron/poll-kie-tasks
        A->>K: Check status
        K-->>A: Result URL
        A->>DB: Update result
    end

    U->>A: GET /api/avatars/{id}
    A->>DB: Get photos
    A-->>U: Generated photos
            </div>

            <h3>Тарифы генерации</h3>
            <table>
                <tr><th>Тариф</th><th>Фото</th><th>RUB</th><th>Stars</th><th>TON</th></tr>
                <tr>
                    <td><span class="badge badge-blue">Starter</span></td>
                    <td>7</td>
                    <td>499 / 150 (скидка 70%)</td>
                    <td>99</td>
                    <td>1.5</td>
                </tr>
                <tr>
                    <td><span class="badge badge-green">Standard</span></td>
                    <td>15</td>
                    <td>999</td>
                    <td>199</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td><span class="badge badge-pink">Premium</span></td>
                    <td>23</td>
                    <td>1499</td>
                    <td>299</td>
                    <td>4.5</td>
                </tr>
            </table>
        </section>

        <!-- UI USER -->
        <section id="ui-user">
            <h2>Пользовательский интерфейс</h2>

            <h3>Экраны приложения</h3>

            <div class="admin-feature">
                <h4>Dashboard (Мои аватары)</h4>
                <p>Главный экран после авторизации. Показывает созданные аватары пользователя.</p>
                <ul class="features-list">
                    <li>Кнопка "Создать" для нового аватара</li>
                    <li>Карточки существующих аватаров со статусом (Черновик / Готов)</li>
                    <li>Thumbnail превью для каждого аватара</li>
                    <li>Переход в галерею результатов по клику</li>
                </ul>
            </div>

            <div class="admin-feature">
                <h4>Upload (Загрузка фото)</h4>
                <p>Загрузка референсных фотографий для AI-генерации.</p>
                <ul class="features-list">
                    <li>Drag-n-drop загрузка или выбор из галереи</li>
                    <li>Прогресс-бар: 0/8 фото (мин. 5, макс. 20)</li>
                    <li>Превью загруженных фото с возможностью удаления</li>
                    <li>Советы для лучшего результата (освещение, ракурсы)</li>
                    <li>Кнопка "Создать" после загрузки минимума фото</li>
                </ul>
            </div>

            <div class="admin-feature">
                <h4>Referral Panel (Реферальная программа)</h4>
                <p>Модальное окно с информацией о реферальной программе.</p>
                <ul class="features-list">
                    <li>Персональный реферальный код с кнопкой копирования</li>
                    <li>Баланс: заработано всего, доступно к выводу</li>
                    <li>Статистика: приглашено пользователей, оплатили</li>
                    <li>История начислений с датами и суммами</li>
                    <li>Кнопка "Стать партнёром" для получения 50% комиссии</li>
                </ul>
            </div>

            <div class="admin-feature">
                <h4>Payment Modal (Выбор тарифа)</h4>
                <p>Модальное окно выбора тарифа и способа оплаты.</p>
                <ul class="features-list">
                    <li>3 тарифа: Starter (7 фото), Standard (15), Premium (23)</li>
                    <li>Метка "Популярный" на Standard</li>
                    <li>Отображение скидок (70% на Starter)</li>
                    <li>3 способа оплаты: Карта (T-Bank), Stars, TON</li>
                </ul>
            </div>

            <div class="admin-feature">
                <h4>Results (Галерея результатов)</h4>
                <p>Просмотр сгенерированных AI-фотографий.</p>
                <ul class="features-list">
                    <li>Сетка сгенерированных фото (до 23 штук)</li>
                    <li>Полноэкранный просмотр по клику</li>
                    <li>Скачивание отдельных фото и всех сразу</li>
                    <li>Кнопка "Создать ещё" для новой генерации</li>
                </ul>
            </div>
        </section>

        <!-- UI ADMIN (11 sections) -->
        <section id="ui-admin">
            <h2>Админ панель</h2>

            <p>Админ панель PinGlass содержит <strong>11 секций</strong> для полного управления платформой. Доступ через авторизацию по Email/Password или Google OAuth.</p>

            <h3>Навигация</h3>
            <div class="tabs-indicator">
                <span class="tab-badge">Dashboard</span>
                <span class="tab-badge">Users</span>
                <span class="tab-badge">Payments</span>
                <span class="tab-badge">Generations</span>
                <span class="tab-badge">Prompts</span>
                <span class="tab-badge">Referrals</span>
                <span class="tab-badge">Partners</span>
                <span class="tab-badge">Telegram</span>
                <span class="tab-badge">Support</span>
                <span class="tab-badge">Logs</span>
                <span class="tab-badge">Settings</span>
            </div>
        </section>

        <!-- ADMIN SECTIONS DETAILED -->
        <section id="admin-sections">
            <h2>11 секций админ панели (детально)</h2>

            <!-- 1. DASHBOARD -->
            <div class="admin-feature">
                <h4>1. Dashboard</h4>
                <p>Главная страница с ключевыми метриками бизнеса.</p>
                <div class="kpi-list">
                    <span class="kpi-item">Users (всего)</span>
                    <span class="kpi-item">Revenue MTD</span>
                    <span class="kpi-item">Avg Check</span>
                    <span class="kpi-item">Generations</span>
                </div>
                <ul class="features-list">
                    <li><strong>KPI карточки</strong> — пользователи, выручка за месяц, средний чек, генерации</li>
                    <li><strong>Провайдеры платежей</strong> — T-Bank, TON, Telegram Stars с суммами</li>
                    <li><strong>График выручки 30 дней</strong> — линейный график с daily revenue</li>
                    <li><strong>Распределение по тарифам</strong> — круговая диаграмма Starter/Standard/Premium</li>
                </ul>
            </div>

            <!-- 2. USERS -->
            <div class="admin-feature">
                <h4>2. Users (Пользователи)</h4>
                <p>Управление всеми пользователями платформы.</p>
                <ul class="features-list">
                    <li><strong>Поиск</strong> — по Telegram ID, username, email</li>
                    <li><strong>Таблица</strong> — ID, Telegram ID, Username, Статус, Аватары, Платежи, Потрачено, Ref, Gen, TG, Создан, Действия</li>
                    <li><strong>Действия</strong> — "Детали", "Сделать Partner"</li>
                    <li><strong>Модальное окно деталей</strong> с 5 вкладками:</li>
                </ul>
                <div class="tabs-indicator">
                    <span class="tab-badge">Обзор</span>
                    <span class="tab-badge">Аватары</span>
                    <span class="tab-badge">Платежи</span>
                    <span class="tab-badge">Генерации</span>
                    <span class="tab-badge">Реферал</span>
                </div>
                <ul class="features-list">
                    <li><strong>Обзор</strong> — ID, Telegram ID, Username, дата регистрации, статистика</li>
                    <li><strong>Аватары</strong> — список созданных аватаров с превью</li>
                    <li><strong>Платежи</strong> — история платежей пользователя</li>
                    <li><strong>Генерации</strong> — список генераций со статусами</li>
                    <li><strong>Реферал</strong> — реферальный код, баланс, приглашённые</li>
                </ul>
            </div>

            <!-- 3. PAYMENTS -->
            <div class="admin-feature">
                <h4>3. Payments (Платежи)</h4>
                <p>Мониторинг и управление всеми платежами.</p>
                <div class="kpi-list">
                    <span class="kpi-item">Total Revenue</span>
                    <span class="kpi-item">Net Revenue</span>
                    <span class="kpi-item">Avg Check</span>
                    <span class="kpi-item">T-Bank</span>
                    <span class="kpi-item">TON</span>
                    <span class="kpi-item">Stars</span>
                </div>
                <ul class="features-list">
                    <li><strong>Фильтры</strong> — Статус (succeeded/pending/refunded), Тариф, Провайдер, Период</li>
                    <li><strong>Кнопки</strong> — Export (CSV), Refresh</li>
                    <li><strong>Таблица</strong> — ID, User, Amount, Tariff, Status, Provider, TG photo, Refund, Date, Actions</li>
                    <li><strong>Статусы</strong> — succeeded (зелёный), pending (жёлтый), refunded (красный)</li>
                    <li><strong>Действия</strong> — Refund (возврат одним кликом)</li>
                </ul>
            </div>

            <!-- 4. GENERATIONS -->
            <div class="admin-feature">
                <h4>4. Generations (Генерации)</h4>
                <p>Мониторинг очереди AI-генерации.</p>
                <div class="kpi-list">
                    <span class="kpi-item">Total</span>
                    <span class="kpi-item">Completed</span>
                    <span class="kpi-item">In Progress</span>
                    <span class="kpi-item">Errors</span>
                    <span class="kpi-item">Success Rate</span>
                    <span class="kpi-item">Avg Time</span>
                </div>
                <ul class="features-list">
                    <li><strong>Auto-refresh</strong> — автоматическое обновление статусов</li>
                    <li><strong>Фильтры</strong> — по статусу, периоду</li>
                    <li><strong>Таблица</strong> — ID, Avatar, Style, Progress (прогресс-бар), Status, Time, Date, Actions</li>
                    <li><strong>Статусы</strong> — completed, in_progress, failed</li>
                    <li><strong>Действия</strong> — Retry (перезапуск), View (просмотр результатов)</li>
                </ul>
            </div>

            <!-- 5. PROMPTS -->
            <div class="admin-feature">
                <h4>5. Prompts (Промпты)</h4>
                <p>Редактор AI-промптов и фотопаков.</p>
                <div class="tabs-indicator">
                    <span class="tab-badge">Тестер</span>
                    <span class="tab-badge">Сохранённые промпты (40)</span>
                    <span class="tab-badge">Фотопаки (2)</span>
                </div>
                <ul class="features-list">
                    <li><strong>Тестер</strong>:
                        <ul>
                            <li>Загрузка референсных изображений (5-10 фото)</li>
                            <li>Тестовые блоки для разных промптов</li>
                            <li>Кнопка "KIE AI" для тестовой генерации</li>
                        </ul>
                    </li>
                    <li><strong>Сохранённые промпты</strong>:
                        <ul>
                            <li>40 промптов с превью результатов</li>
                            <li>Фильтры: PinGlass, DREAM PACK</li>
                            <li>Кнопка "Generate All" для массовой генерации</li>
                        </ul>
                    </li>
                    <li><strong>Фотопаки</strong>:
                        <ul>
                            <li>PinGlass Premium (23 промпта)</li>
                            <li>DREAM PACK (23 промпта)</li>
                            <li>Управление составом паков</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- 6. REFERRALS -->
            <div class="admin-feature">
                <h4>6. Referrals (Рефералы)</h4>
                <p>Статистика и управление реферальной программой.</p>
                <div class="kpi-list">
                    <span class="kpi-item">Referrals (всего)</span>
                    <span class="kpi-item">Withdrawal Requests</span>
                    <span class="kpi-item">Conversion Rate</span>
                    <span class="kpi-item">Stars TG Affiliate</span>
                </div>
                <ul class="features-list">
                    <li><strong>Валюты</strong> — RUB (заработано/баланс/выведено), TON</li>
                    <li><strong>Воронка</strong> — Коды → Зарегистрированные → Оплатившие</li>
                </ul>
                <div class="tabs-indicator">
                    <span class="tab-badge">Обзор</span>
                    <span class="tab-badge">Топ рефереров</span>
                    <span class="tab-badge">Выводы</span>
                    <span class="tab-badge">Telegram Stars</span>
                </div>
                <ul class="features-list">
                    <li><strong>Топ рефереров</strong> — Telegram ID, Code, Referrals, Conversions, Earned, Balance</li>
                    <li><strong>Выводы</strong> — запросы на вывод средств</li>
                </ul>
            </div>

            <!-- 7. PARTNERS -->
            <div class="admin-feature">
                <h4>7. Partners (Партнёры)</h4>
                <p>Управление партнёрской программой (50% комиссия).</p>
                <div class="kpi-list">
                    <span class="kpi-item">Partners (всего)</span>
                    <span class="kpi-item">Paid to Partners</span>
                    <span class="kpi-item">Referrals from Partners</span>
                    <span class="kpi-item">Awaiting Review</span>
                </div>
                <div class="tabs-indicator">
                    <span class="tab-badge">Заявки</span>
                    <span class="tab-badge">Партнёры</span>
                    <span class="tab-badge">Одобренные</span>
                    <span class="tab-badge">Отклонённые</span>
                </div>
                <ul class="features-list">
                    <li><strong>Заявки</strong> — новые заявки на партнёрство, Approve/Reject</li>
                    <li><strong>Партнёры</strong> — таблица: Partner, Commission (50%), Referrals, Earned, Balance, Since, Actions</li>
                    <li><strong>Действия</strong> — изменение комиссии, деактивация</li>
                </ul>
            </div>

            <!-- 8. TELEGRAM -->
            <div class="admin-feature">
                <h4>8. Telegram (Рассылки)</h4>
                <p>Создание и отправка Telegram рассылок.</p>
                <div class="tabs-indicator">
                    <span class="tab-badge">Рассылка</span>
                    <span class="tab-badge">Очередь</span>
                </div>
                <ul class="features-list">
                    <li><strong>Новая рассылка</strong>:
                        <ul>
                            <li><strong>Recipients (сегменты)</strong> — All users, Paid, Active 30 days, Partners, Specific users</li>
                            <li><strong>Photo</strong> — загрузка фото (до 5MB)</li>
                            <li><strong>Message</strong> — текст с HTML форматированием (B, I, S, code, link)</li>
                            <li><strong>Кнопки</strong> — "Check recipients" (проверка), "Send broadcast" (отправка)</li>
                        </ul>
                    </li>
                    <li><strong>History</strong> — история отправленных рассылок</li>
                    <li><strong>Очередь</strong> — сообщения в очереди на отправку</li>
                </ul>
            </div>

            <!-- 9. SUPPORT -->
            <div class="admin-feature">
                <h4>9. Support (Тикеты)</h4>
                <p>Система поддержки пользователей.</p>
                <div class="kpi-list">
                    <span class="kpi-item">Всего тикетов</span>
                    <span class="kpi-item">Открытые</span>
                    <span class="kpi-item">В работе</span>
                    <span class="kpi-item">SLA нарушен</span>
                    <span class="kpi-item">Среднее время ответа</span>
                </div>
                <ul class="features-list">
                    <li><strong>Фильтры</strong> — Поиск по номеру/username, Статус, Приоритет, Категория</li>
                    <li><strong>Чекбокс</strong> — "Мои тикеты" (назначенные текущему админу)</li>
                    <li><strong>Таблица</strong> — Номер, Пользователь, Категория, Приоритет, Статус, Назначен, SLA, Создан, Действия</li>
                    <li><strong>Действия</strong> — Ответить, Назначить, Закрыть</li>
                </ul>
            </div>

            <!-- 10. LOGS -->
            <div class="admin-feature">
                <h4>10. Logs (Логи и мониторинг)</h4>
                <p>Отслеживание ошибок и активности через Sentry.</p>
                <ul class="features-list">
                    <li><strong>Live режим</strong> — real-time обновление логов</li>
                    <li><strong>Фильтры</strong> — Все уровни (error/warn/info), Поиск по тексту</li>
                    <li><strong>Таблица</strong> — Уровень (badge), Сообщение, User ID, Время</li>
                    <li><strong>Уровни</strong>:
                        <ul>
                            <li><span class="badge badge-red">error</span> — критические ошибки</li>
                            <li><span class="badge badge-yellow">warn</span> — предупреждения</li>
                            <li><span class="badge badge-blue">info</span> — информационные</li>
                        </ul>
                    </li>
                    <li><strong>Кнопка</strong> — "Обновить"</li>
                </ul>
            </div>

            <!-- 11. SETTINGS -->
            <div class="admin-feature">
                <h4>11. Settings (Настройки)</h4>
                <p>Конфигурация тарифов и платёжных систем.</p>
                <ul class="features-list">
                    <li><strong>Тарифы</strong> — 3 карточки:
                        <ul>
                            <li><strong>Starter</strong>: Цена 499р, Скидка 70% (Итого: 150р), 7 фото, Активный тариф</li>
                            <li><strong>Standard</strong>: Цена 999р, 15 фото, Популярный, Активный тариф</li>
                            <li><strong>Premium</strong>: Цена 1499р, 23 фото, Активный тариф</li>
                        </ul>
                    </li>
                    <li><strong>Предпросмотр</strong> — как тарифы выглядят для пользователя</li>
                    <li><strong>Telegram Stars</strong> (toggle включен):
                        <ul>
                            <li>Цены: Starter 99, Standard 199, Premium 299</li>
                            <li>Info: "1 Star ~ 1.8 RUB (курс Telegram)"</li>
                        </ul>
                    </li>
                    <li><strong>TON Crypto</strong> (toggle включен):
                        <ul>
                            <li>Адрес кошелька (с копированием)</li>
                            <li>Цены: Starter 1.5 TON, Standard 3 TON, Premium 4.5 TON</li>
                            <li>Info: "Курс TON обновляется автоматически каждые 5 минут"</li>
                        </ul>
                    </li>
                    <li><strong>T-Bank</strong>:
                        <ul>
                            <li>Режим работы: Test / Production (toggle)</li>
                            <li>Статус: "Сейчас активен боевой режим"</li>
                            <li>Ключи доступа: Test (Terminal Key, Password), Production (Terminal Key, Password)</li>
                            <li>Warning: "Ключи хранятся в зашифрованном виде в базе данных"</li>
                        </ul>
                    </li>
                    <li><strong>Кнопка</strong> — "Сохранить"</li>
                </ul>
            </div>
        </section>

        <!-- TELEGRAM MINI APP -->
        <section id="telegram-mini-app">
            <h2>Telegram Mini App</h2>

            <p>PinGlass интегрирован как Telegram Mini App (TMA), что обеспечивает:</p>

            <div class="card-grid">
                <div class="card">
                    <h4>Авторизация</h4>
                    <p>Автоматическая авторизация через Telegram. Пользователь идентифицируется по telegram_user_id без логина/пароля.</p>
                </div>
                <div class="card">
                    <h4>Telegram Stars</h4>
                    <p>Оплата внутренней валютой Telegram. Мгновенное подтверждение через Bot API.</p>
                </div>
                <div class="card">
                    <h4>TON Connect</h4>
                    <p>Интеграция с Tonkeeper и другими TON кошельками. returnStrategy для возврата в приложение.</p>
                </div>
                <div class="card">
                    <h4>Уведомления</h4>
                    <p>Push-уведомления о готовности генерации через Telegram Bot.</p>
                </div>
            </div>

            <h3>Особенности TMA</h3>
            <ul>
                <li><strong>TWA SDK</strong> — @twa-dev/sdk для взаимодействия с Telegram</li>
                <li><strong>Theme</strong> — автоматическая адаптация под тему Telegram (light/dark)</li>
                <li><strong>Back Button</strong> — нативная кнопка "Назад" в header</li>
                <li><strong>Main Button</strong> — нативная кнопка действия внизу экрана</li>
                <li><strong>Haptic Feedback</strong> — вибрация при действиях</li>
                <li><strong>returnStrategy</strong> — возврат в приложение после оплаты через кошелёк</li>
            </ul>

            <h3>TON Connect интеграция</h3>
            <pre><code>// lib/tonconnect/provider.tsx
import { TonConnectUIProvider } from '@tonconnect/ui-react';

// Manifest для кошельков
const manifestUrl = 'https://pinglass.ru/tonconnect-manifest.json';

// Для TMA: возврат в приложение после подключения
const returnStrategy = 'back'; // или tg://resolve?domain=PinGlassBot
</code></pre>
        </section>

        <!-- USER FLOW -->
        <section id="user-flow">
            <h2>User Flow</h2>

            <h3>Путь нового пользователя</h3>
            <div class="mermaid">
flowchart LR
    A[Открытие TMA] --> B{Onboarding?}
    B -->|Нет| C[Onboarding 3 шага]
    C --> D[Dashboard]
    B -->|Да| D
    D --> E[Создать аватар]
    E --> F[Загрузить 5-8 фото]
    F --> G[Выбрать тариф]
    G --> H{Оплата}
    H -->|T-Bank| I[Редирект]
    H -->|Stars| J[Bot API]
    H -->|TON| K[Tonkeeper]
    I --> L[Callback]
    J --> L
    K --> L
    L --> M[Генерация]
    M --> N[Галерея]
    N --> O[Скачивание]
            </div>

            <h3>Состояния аватара</h3>
            <div class="mermaid">
stateDiagram-v2
    [*] --> draft: Создан
    draft --> uploading: Загрузка фото
    uploading --> ready_to_pay: Фото загружены
    ready_to_pay --> processing: Оплачен
    processing --> ready: Генерация завершена
    processing --> failed: Ошибка
    failed --> processing: Retry
    ready --> [*]
            </div>
        </section>

        <!-- DEPLOYMENT -->
        <section id="deployment">
            <h2>Деплой</h2>

            <h3>Vercel конфигурация</h3>
            <pre><code>// vercel.json
{
  "functions": {
    "app/api/jobs/process/route.ts": { "maxDuration": 60 },
    "app/api/cron/poll-kie-tasks/route.ts": { "maxDuration": 55 },
    "app/api/generate/route.ts": { "maxDuration": 60 }
  },
  "crons": [
    { "path": "/api/cron/poll-kie-tasks", "schedule": "*/1 * * * *" },
    { "path": "/api/cron/check-stuck-jobs", "schedule": "*/5 * * * *" }
  ]
}</code></pre>

            <h3>Деплой команды</h3>
            <table>
                <tr><th>Команда</th><th>Описание</th></tr>
                <tr><td><code>vercel</code></td><td>Preview deployment</td></tr>
                <tr><td><code>vercel --prod</code></td><td>Production deployment</td></tr>
                <tr><td><code>vercel logs --follow</code></td><td>Мониторинг логов</td></tr>
                <tr><td><code>vercel env pull</code></td><td>Синхронизация env</td></tr>
            </table>
        </section>

        <!-- ENV VARS -->
        <section id="env-vars">
            <h2>Переменные окружения</h2>

            <h3>Обязательные</h3>
            <table>
                <tr><th>Переменная</th><th>Описание</th></tr>
                <tr><td><code>DATABASE_URL</code></td><td>Neon PostgreSQL connection string</td></tr>
                <tr><td><code>NEXT_PUBLIC_APP_URL</code></td><td>URL приложения (https://pinglass.ru)</td></tr>
                <tr><td><code>QSTASH_TOKEN</code></td><td>QStash API token</td></tr>
                <tr><td><code>QSTASH_CURRENT_SIGNING_KEY</code></td><td>QStash signing key</td></tr>
                <tr><td><code>CRON_SECRET</code></td><td>Секрет для cron endpoints</td></tr>
            </table>

            <h3>Платежи</h3>
            <table>
                <tr><th>Переменная</th><th>Описание</th></tr>
                <tr><td><code>TBANK_TERMINAL_KEY</code></td><td>T-Bank Terminal ID</td></tr>
                <tr><td><code>TBANK_PASSWORD</code></td><td>T-Bank API Password</td></tr>
                <tr><td><code>TELEGRAM_BOT_TOKEN</code></td><td>Telegram Bot для Stars</td></tr>
                <tr><td><code>TON_WALLET_ADDRESS</code></td><td>Адрес для приёма TON</td></tr>
            </table>

            <h3>AI Генерация</h3>
            <table>
                <tr><th>Переменная</th><th>Описание</th></tr>
                <tr><td><code>KIE_API_KEY</code></td><td>Kie.ai API ключ</td></tr>
                <tr><td><code>REPLICATE_API_TOKEN</code></td><td>Replicate fallback</td></tr>
                <tr><td><code>CLOUDFLARE_R2_*</code></td><td>R2 storage credentials</td></tr>
            </table>
        </section>

        <footer style="text-align: center; padding: 40px; color: #6b7280;">
            <p>PinGlass 2026 | Документация v3.0</p>
            <p>Обновлено: <script>document.write(new Date().toLocaleDateString('ru-RU'))</script></p>
        </footer>
    </main>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral',
            flowchart: { curve: 'basis' }
        });

        // Smooth scroll for navigation
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(link.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
                // Update active state
                document.querySelectorAll('nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Highlight current section on scroll
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('nav a');

            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
