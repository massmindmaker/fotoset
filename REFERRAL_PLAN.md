# План партнёрской программы PinGlass

## Обзор

Реферальная программа где пользователи получают **10% от стоимости** каждой генерации привлечённых пользователей. Накопленные средства можно вывести от **5000 ₽**.

---

## Экономика

### Текущие тарифы
| Тариф | Цена | 10% партнёру |
|-------|------|--------------|
| Starter (7 фото) | 499 ₽ | 49.9 ₽ |
| Standard (15 фото) | 999 ₽ | 99.9 ₽ |
| Premium (23 фото) | 1499 ₽ | 149.9 ₽ |

### Пример заработка
- Привлёк 10 пользователей Standard → 999 ₽ накоплено
- Привлёк 50 пользователей Standard → 4995 ₽ (почти вывод)
- Привлёк 51 пользователя Standard → 5094 ₽ → можно вывести

---

## Выплаты: Варианты для ИП

### Вариант 1: T-Bank Массовые выплаты (рекомендуется)
**Подходит для ИП с расчётным счётом в Т-Банк**

- **API:** https://www.tbank.ru/kassa/dev/payouts/
- **Способ:** Перевод на карту по номеру карты или телефона
- **Скорость:** Мгновенно (даже в выходные)
- **Комиссия:** от 0.5% (уточнить у менеджера)
- **Минимум:** Нет ограничений
- **НДФЛ:** Автоматическое формирование платёжек

**Преимущества:**
- Полная автоматизация через API
- Интеграция с текущим эквайрингом
- Автоматический расчёт НДФЛ 13%

### Вариант 2: Ручные переводы через банк-клиент
**Подходит на старте (до 20-30 выплат/месяц)**

- **Способ:** Ручной перевод с р/с ИП на карту партнёра
- **Комиссия:** 0-50 ₽ за перевод (зависит от тарифа ИП)
- **Скорость:** 1-3 рабочих дня

**Минусы:**
- Ручная работа
- Нужно самому считать НДФЛ

### Вариант 3: Выплаты только самозанятым/ИП
**Минимум юридических сложностей**

- Партнёр регистрируется как самозанятый
- Выставляет чек через "Мой налог"
- Перевод без удержания НДФЛ
- Партнёр сам платит 4-6% налог

---

## Юридические требования для ИП

### При выплате физлицам (не самозанятым)
1. **Договор оферты** — партнёр акцептует при регистрации
2. **НДФЛ 13%** — ИП как налоговый агент удерживает и платит
3. **6-НДФЛ** — квартальная отчётность по выплатам
4. **Страховые взносы** — НЕ нужны (это не зарплата, а вознаграждение по договору ГПХ)

### При выплате самозанятым
1. **Чек из "Мой налог"** — партнёр присылает перед выплатой
2. **Никаких удержаний** — переводите полную сумму
3. **Никакой отчётности** — всё на стороне самозанятого

### Рекомендация
**Начать с выплат только самозанятым** — проще юридически, меньше отчётности.

---

## Архитектура базы данных

### Новые таблицы

```sql
-- Реферальные коды партнёров
CREATE TABLE referral_codes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    code VARCHAR(12) UNIQUE NOT NULL,  -- Уникальный код: "ABC123"
    created_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE
);

-- Реферальные связи (кто кого привёл)
CREATE TABLE referrals (
    id SERIAL PRIMARY KEY,
    referrer_id INTEGER NOT NULL REFERENCES users(id),  -- Кто привёл
    referred_id INTEGER NOT NULL REFERENCES users(id),  -- Кого привели
    referral_code VARCHAR(12) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(referred_id)  -- Один пользователь может быть привлечён только один раз
);

-- Начисления партнёрам
CREATE TABLE referral_earnings (
    id SERIAL PRIMARY KEY,
    referrer_id INTEGER NOT NULL REFERENCES users(id),
    referred_id INTEGER NOT NULL REFERENCES users(id),
    payment_id INTEGER REFERENCES payments(id),
    amount DECIMAL(10,2) NOT NULL,  -- Сумма начисления (10% от платежа)
    original_amount DECIMAL(10,2) NOT NULL,  -- Исходная сумма платежа
    created_at TIMESTAMP DEFAULT NOW()
);

-- Баланс партнёра (денормализованная таблица для скорости)
CREATE TABLE referral_balances (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL REFERENCES users(id),
    balance DECIMAL(10,2) DEFAULT 0,  -- Текущий баланс
    total_earned DECIMAL(10,2) DEFAULT 0,  -- Всего заработано
    total_withdrawn DECIMAL(10,2) DEFAULT 0,  -- Всего выведено
    referrals_count INTEGER DEFAULT 0,  -- Кол-во привлечённых
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Заявки на вывод
CREATE TABLE referral_withdrawals (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id),
    amount DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, processing, completed, rejected

    -- Реквизиты для выплаты
    payout_method VARCHAR(20) NOT NULL,  -- card, phone, selfemployed
    payout_details JSONB NOT NULL,  -- {card: "4276...", phone: "+7..."}

    -- Для самозанятых
    inn VARCHAR(12),
    receipt_url TEXT,  -- Ссылка на чек из "Мой налог"

    -- Служебное
    processed_by VARCHAR(100),  -- Кто обработал
    processed_at TIMESTAMP,
    rejection_reason TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Индексы
CREATE INDEX idx_referral_codes_code ON referral_codes(code);
CREATE INDEX idx_referrals_referrer ON referrals(referrer_id);
CREATE INDEX idx_earnings_referrer ON referral_earnings(referrer_id);
CREATE INDEX idx_withdrawals_status ON referral_withdrawals(status);
```

---

## API Routes

### Партнёрский кабинет

```
GET  /api/referral/stats         — Статистика партнёра (баланс, рефералы)
GET  /api/referral/code          — Получить/создать реферальный код
GET  /api/referral/earnings      — История начислений
POST /api/referral/withdraw      — Заявка на вывод
GET  /api/referral/withdrawals   — История выводов
```

### Регистрация реферала

```
POST /api/referral/apply         — Применить реферальный код при регистрации
```

### Админка (для обработки выводов)

```
GET  /api/admin/withdrawals      — Список заявок на вывод
POST /api/admin/withdrawals/[id] — Обработать заявку (approve/reject)
```

---

## User Flow

### 1. Партнёр получает код
```
Партнёр → Открывает "Партнёрская программа" → Видит свой код: ABC123
         → Копирует ссылку: https://app.com/?ref=ABC123
```

### 2. Новый пользователь приходит по ссылке
```
Новый юзер → Переходит по /?ref=ABC123
           → Код сохраняется в localStorage
           → После оплаты: создаётся связь referrals
           → Партнёру начисляется 10%
```

### 3. Партнёр выводит деньги
```
Партнёр → Баланс: 5200 ₽ → "Вывести"
        → Выбирает способ: Карта / СБП / Самозанятый
        → Вводит реквизиты
        → (Если самозанятый) Загружает чек
        → Заявка создана → Ожидание обработки
        → Админ одобряет → Деньги переводятся
```

---

## UI компоненты

### 1. Секция в настройках/профиле
```
┌─────────────────────────────────────────┐
│  💰 Партнёрская программа               │
├─────────────────────────────────────────┤
│  Ваш код: ABC123        [Копировать]   │
│                                         │
│  Ссылка для друзей:                    │
│  https://app.com/?ref=ABC123 [📋]      │
│                                         │
│  ────────────────────────────────────  │
│                                         │
│  Баланс:        1 250 ₽                │
│  Привлечено:    15 человек             │
│  Всего заработано: 2 100 ₽             │
│                                         │
│  [История начислений]                  │
│                                         │
│  ────────────────────────────────────  │
│                                         │
│  ⚠️ Вывод доступен от 5 000 ₽          │
│                                         │
│  [Вывести средства] (неактивна)        │
└─────────────────────────────────────────┘
```

### 2. Модалка вывода средств
```
┌─────────────────────────────────────────┐
│  Вывод средств                    [✕]  │
├─────────────────────────────────────────┤
│  Сумма к выводу: 5 200 ₽               │
│                                         │
│  Способ получения:                     │
│  ○ На карту (с удержанием НДФЛ 13%)   │
│  ○ По номеру телефона (СБП)           │
│  ● Я самозанятый (без удержаний)      │
│                                         │
│  ────────────────────────────────────  │
│                                         │
│  ИНН: [____________]                   │
│                                         │
│  Чек из "Мой налог":                   │
│  [Загрузить чек] или [Ввести ссылку]   │
│                                         │
│  ────────────────────────────────────  │
│                                         │
│  К получению: 5 200 ₽                  │
│                                         │
│  [Отправить заявку]                    │
└─────────────────────────────────────────┘
```

---

## Порядок реализации

### Фаза 1: База (2-3 дня)
1. SQL миграция — создать таблицы
2. API `/api/referral/code` — генерация кода
3. API `/api/referral/stats` — получение статистики
4. Сохранение `ref` параметра в localStorage
5. Привязка реферала при первом платеже

### Фаза 2: Начисления (1-2 дня)
1. Хук после успешного платежа — начисление 10%
2. API `/api/referral/earnings` — история начислений
3. Обновление баланса в `referral_balances`

### Фаза 3: UI партнёра (2-3 дня)
1. Секция "Партнёрская программа" в профиле
2. Отображение кода, ссылки, статистики
3. История начислений с пагинацией

### Фаза 4: Выводы (3-4 дня)
1. API `/api/referral/withdraw` — создание заявки
2. Модалка вывода с выбором способа
3. Админ-панель для обработки заявок
4. Интеграция T-Bank Payouts API (или ручные выплаты)

### Фаза 5: Автоматизация (опционально)
1. Автовыплаты через T-Bank API
2. Email-уведомления о начислениях
3. Push-уведомления

---

## Риски и митигации

| Риск | Митигация |
|------|-----------|
| Фрод (самореги) | Начисление только после оплаты, не регистрации |
| Массовые мелкие выводы | Минимум 5000 ₽ для вывода |
| Юридические проблемы | Начать только с самозанятых |
| Сложность выплат | Сначала ручные переводы, потом API |

---

## Источники

- [T-Bank Массовые выплаты API](https://www.tbank.ru/kassa/dev/payouts/)
- [T-Bank Выплаты физлицам](https://www.tinkoff.ru/corporate/payout/b2c-mass-payments/)
- [Опыт Veezy с автовыплатами](https://secrets.tinkoff.ru/lichnyj-opyt/veezy-api/)
